#
# tdnf spec file
#

%define _python3_sitearch %(python3 -c "from distutils.sysconfig import get_python_lib; import sys; sys.stdout.write(get_python_lib(1))")

Summary:        dnf/yum equivalent using C libs
Name:           tdnf
Version:        @VERSION@
Release:        1%{?dist}
Vendor:         VMware, Inc.
Distribution:   Photon
License:        LGPLv2.1,GPLv2
URL:            http://www.vmware.com
Group:          Applications/RPM
Requires:       rpm-libs
Requires:       curl
Requires:       tdnf-cli-libs = %{version}-%{release}
Requires:       libsolv
BuildRequires:  popt-devel
BuildRequires:  rpm-devel
BuildRequires:  openssl-devel
BuildRequires:  libsolv-devel
BuildRequires:  curl-devel
Source0:        %{name}-%{version}.tar.gz

%description
tdnf is a yum/dnf equivalent which uses libsolv and libcurl

%package    devel
Summary:    A Library providing C API for tdnf
Group:      Development/Libraries
Requires:   tdnf = %{version}-%{release}
Requires:   libsolv-devel

%description devel
Development files for tdnf

%package	cli-libs
Summary:	Library providing cli libs for tdnf like clients
Group:		Development/Libraries

%description cli-libs
Library providing cli libs for tdnf like clients.

%package -n python2-tdnf
Summary: Python2 bindings for tdnf
Group: Development/Libraries
Requires: python2 >= 2.7
Requires: %{name} = %{version}-%{release}
BuildRequires: python2-devel >= 2.7

%description -n python2-tdnf
Python2 bindings for tdnf

%package -n python3-tdnf
Summary: Python3 bindings for tdnf
Group: Development/Libraries
Requires: python3 >= 3.5
Requires: %{name} = %{version}-%{release}
BuildRequires: python3-devel >= 3.5

%description -n python3-tdnf
Python3 bindings for tdnf

%prep
%setup -q %{name}-%{version}

%build
autoreconf -i
%configure \
    --disable-static \
    --enable-python
make %{?_smp_mflags}

pushd python
python2 setup.py build
python3 setup.py build
popd

%install
make DESTDIR=%{buildroot} install
find %{buildroot} -name '*.la' -delete
mkdir -p %{buildroot}/var/cache/tdnf

pushd python
python2 setup.py install --skip-build --root %{buildroot}
python3 setup.py install --skip-build --root %{buildroot}
popd

# Pre-install
%pre

    # First argument is 1 => New Installation
    # First argument is 2 => Upgrade

# Post-install
%post

    # First argument is 1 => New Installation
    # First argument is 2 => Upgrade

    /sbin/ldconfig

# Pre-uninstall
%preun

    # First argument is 0 => Uninstall
    # First argument is 1 => Upgrade

# Post-uninstall
%postun

    /sbin/ldconfig

    # First argument is 0 => Uninstall
    # First argument is 1 => Upgrade

%files
    %defattr(-,root,root,0755)
    %{_bindir}/tdnf
    %{_libdir}/libtdnf.so.*
    %config(noreplace) %{_sysconfdir}/tdnf/tdnf.conf
    %dir /var/cache/tdnf

%files devel
    %defattr(-,root,root)
    %{_includedir}/tdnf/*.h
    %{_libdir}/libtdnf.so
    %{_libdir}/libtdnfcli.so
    %exclude %{_libdir}/debug
    %{_libdir}/pkgconfig/tdnf.pc
    %{_libdir}/pkgconfig/tdnf-cli-libs.pc

%files cli-libs
    %defattr(-,root,root)
    %{_libdir}/libtdnfcli.so.*

%files -n python2-tdnf
    %{python_sitearch}/%{name}/
    %{python_sitearch}/%{name}-*.egg-info

%files -n python3-tdnf
    %{_python3_sitearch}/%{name}/
    %{_python3_sitearch}/%{name}-*.egg-info

%changelog
*   Fri Jan 23 2015 Priyesh Padmavilasom <ppadmavilasom@vmware.com> 1.0
-   Initial build.  First version
